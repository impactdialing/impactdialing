<script src="/javascripts/recurly.min.js" type="text/javascript"></script>

<% content_for :stylesheets do %>
  <link rel="stylesheet" href="/stylesheets/recurly_overrides.css?v=1" type="text/css" />
  <link rel="stylesheet" href="/stylesheets/recurly.css" type="text/css" />
<% end %>

<script>

function handlePlan(selectb){
  if (selectb.selectedIndex==0)
    createForm('per-minute');
  else
    createForm('per-caller');
}
Recurly.config({
    subdomain: '<%= RECURLY_SUBDOMAIN %>'
  , currency: 'USD'
  }
);


<%
minute_signature = Recurly.js.sign :subscription => { :plan_code => 'per-minute' }
caller_signature = Recurly.js.sign :subscription => { :plan_code => 'per-caller' }
%>
function createForm(plan){
  var sig = '<%= minute_signature %>';
  if (plan=='per-caller')
    sig = '<%= caller_signature %>';
  Recurly.buildSubscriptionForm({
    target: '#recurly-form'
    , accountCode: '<%= @account_code %>'
    , distinguishContactFromBillingInfo: false
  ,account: {
      firstName: '<%= @user.fname %>'
    , lastName: '<%= @user.lname %>'
    , email: '<%= @user.email %>'
  },
  planCode: plan,
  successURL: 'http://<%= Settings.twilio_callback_host %><%= Settings.twilio_callback_port=="80" ? "" : ":#{Settings.twilio_callback_port}/client/billing_success" %>',
  signature: sig,
  afterInject: function(){
    if (plan=='per-minute'){
      $('.cost').hide();
      $('.recurring_cost').hide();
      $('.due_now').hide();
      }
    },
  });
}

</script>

<div role="main">
  <h1>Set up billing</h1>

  <fieldset>
  <div>
    <p>Select your plan:<br>
      <select onchange="handlePlan(this);">
      <option>Pay per minute</option>
      <option>Pay per caller</option>
    </select></p>
  </div>
     <div id="recurly-form"></div>
  <script>createForm('per-minute');</script>
  </fieldset>
</div>
